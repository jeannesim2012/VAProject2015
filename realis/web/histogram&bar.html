<!DOCTYPE html>
<html lang="en">
    <head>
        <title>dc.js - Filtering Example</title>
        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/dc.css"/>
    </head>
    <body>

        <div id="chart-hist-unitPrice"></div>
        <div id="chart-row-spenders"></div>
        <div id="chart-line"></div>
        <div id="monthly-volume-chart"></div>
        <a href='javascript:dc.filterAll(); dc.renderAll();'>Reset All</a>

        <script type="text/javascript" src="lib/d3/d3.js"></script>
        <script type="text/javascript" src="lib/crossfilter/crossfilter.js"></script>
        <script type="text/javascript" src="lib/dc/dc.js"></script>
        <script type="text/javascript">

            var unitPriceHistChart = dc.barChart("#chart-hist-unitPrice"),
                    spenderRowChart = dc.rowChart("#chart-row-spenders"),
                    priceLineChart = dc.lineChart("#chart-line"),
                    volumeChart = dc.barChart('#monthly-volume-chart');

            var parseDate = d3.time.format("%d-%b-%y").parse;

            // d3.csv('./data/sample.csv', function(transactions) {
            d3.csv('data/REALIS2014.csv', function (transactions) {
                //Basic Transform
                transactions.forEach(function (d, i) {
                    d.index = i;
                    d.date = parseDate(d.saleDate);
                    d.area = parseInt(d.area, 10);
                    d.unitSold = parseInt(d.unitSold, 10);
                    d.transactedPrice = parseInt(d.transactedPrice, 10);
                    d.unitPricePSM = parseInt(d.unitPricePSM, 10);
                });

                transaction = crossfilter(transactions);
                
                // all = transaction.groupAll();
                date = transaction.dimension(function (d) {
                    return d3.time.day(d.date);
                });

                transactedPriceDim = transaction.dimension(function (d) {
                    return (Math.log(d.transactedPrice));
                });

                unitPricePSMDim = transaction.dimension(function (d) {
                    return (d.unitPricePSM);
                });

                unitPriceHist = unitPricePSMDim.group().reduceCount(function (d) {
                    return d.unitPricePSM;
                });

                projectName = transaction.dimension(function (d) {
                    return d.projectName;
                });

                projectNames = projectName.group();

                planningArea = transaction.dimension(function (d) {
                    return d.planningArea;
                });

                planningRegion = transaction.dimension(function (d) {
                    return d.planningRegion;
                });

                typeOfSale = transaction.dimension(function (d) {
                    return d.typeOfSale;
                });

                unitSoldPerRegion = planningRegion.group().reduceSum(function (d) {
                    return +d.unitSold;
                });

                logTransactionPriceByMonthGroup = date.group().reduceSum(function (d) {
                    return +Math.log(d.transactedPrice);
                });

                spenderRowChart
                        .width(500).height(200)
                        .dimension(planningRegion)
                        .group(unitSoldPerRegion)
                        .elasticX(true);

                unitPriceHistChart
                        .width(400)
                        .height(200)
                        .dimension(unitPricePSMDim)
                        .group(unitPriceHist)
                        .gap(1)
                        .x(d3.scale.linear().domain([1500, 40000]))
                        .elasticY(true);

                priceLineChart
                        .renderArea(true)
                        .width(990)
                        .height(200)
                        .transitionDuration(1000)
                        .margins({top: 30, right: 50, bottom: 25, left: 40})
                        .dimension(date)
                        .mouseZoomable(true)
                        // Specify a "range chart" to link its brush extent with the zoom of the current "focus chart".
                        .rangeChart(volumeChart)
                        .x(d3.time.scale().domain([new Date(2014, 0, 1), new Date(2014, 12, 31)]))
                        .round(d3.time.day.round)
                        .xUnits(d3.time.days)
                        .elasticY(true)
                        .renderHorizontalGridLines(true)
                        //##### Legend
                        // Position the legend relative to the chart origin and specify items' height and separation.
                        .legend(dc.legend().x(800).y(10).itemHeight(13).gap(5))
                        .brushOn(false)
// Add the base layer of the stack with group. The second parameter specifies a series name for use in the legend.
                        // The `.valueAccessor` will be used for the base layer
                        .group(logTransactionPriceByMonthGroup, 'Property Type')
                        .valueAccessor(function (d) {
                            return d.value.avg;
                        })
                        // Stack additional layers with `.stack`. The first paramenter is a new group.
                        // The second parameter is the series name. The third is a value accessor.
                        /*.stack(monthlyMoveGroup, 'Monthly Index Move', function (d) {
                            return d.value;
                        })*/
                        // Title can be called by any stack layer.
                        .title(function (d) {
                            var value = d.value.avg ? d.value.avg : d.value;
                            if (isNaN(value)) {
                                value = 0;
                            }
                            //return 'parseDate(d.date) + '\n' + numberFormat(value)''';
                            return "A";
                        });

                volumeChart.width(990) /* dc.barChart('#monthly-volume-chart', 'chartGroup'); */
                        .height(40)
                        .margins({top: 0, right: 50, bottom: 20, left: 40})
                        .dimension(date)
                        .group(logTransactionPriceByMonthGroup)
                        .centerBar(true)
                        .gap(0.5)
                        .x(d3.time.scale().domain([new Date(2014, 0, 1), new Date(2014, 12, 31)]))
                        .round(d3.time.day.round)
                        .alwaysUseRounding(true)
                        .xUnits(d3.time.days);

                unitPriceHistChart.xAxis().tickFormat(function (d) {
                    return d
                }); // convert back to base unit
                unitPriceHistChart.yAxis().ticks(2);

                dc.renderAll();
            });

        </script>

    </body>
</html>
